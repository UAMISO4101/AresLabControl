{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block head_title %}{{block.super}}Solicitar Muestra % endblock%}

{% block content %}
<div class='row'>

    <div class="col-md-6">
        <h1>Solicitar Muestra</h1>

        <form method="post" action="" name="formSolicitud" id="formSolicitud">

            {% csrf_token %}
            <table class="table table-bordered">
                <tbody>
                    <tr>
                        <td>ID</td>
                        <td>{{ muestra.id}}</td>
                    </tr>
                    <tr>
                        <td>Nombre</td>
                        <td>{{ muestra.nombre}}</td>
                    </tr>
                    <tr>
                        <td>Unidad</td>
                        <td>{{ muestra.unidad }}</td>
                    </tr>
                    <tr>
                        <td>Disponible</td>
                        <td>{{ muestra.calc_disp }}</td>
                    </tr>
                    <tr>
                        <td>Controlado</td>
                        <td>{{ muestra.calc_controled }}</td>
                    </tr>
                    <tr>
                        <td>Cantidad Actual</td>
                        <td id="cantidadActual">{{ muestra.cantidadActual }}</td>
                    </tr>
                    <tr>
                        <td>Proyectos</td>
                        <td>
                            <select class="form-control" name="project" id="project" >
                                <option value="">--Seleccione--</option>
                                {% for proyecto in proyectos %}

                                    <option value="{{proyecto.id}}">{{proyecto.nombre}}</option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>Experimentos</td>
                        <td>
                            <select class="form-control" name="experiment" id="experiment" required>
                                <option value="">--Seleccione--</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>Protocolos</td>
                        <td>

                            <select class="form-control" name="protocol" id="protocol" required>
                                <option value="">--Seleccione--</option>

                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>Pasos</td>
                        <td>

                            <select class="form-control" name="step" id="step" required>
                                <option value="">--Seleccione--</option>

                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>{{form_muestra.cantidad.label}}</td>
                        <td>
                            {{form_muestra.cantidad}}
                        </td>
                    </tr>
                    <tr>
                        <td>{{form.fechaInicial.label}}</td>
                        <td>
                           {{form.fechaInicial}}
                        </td>
                    </tr>
                </tbody>
            </table>
            <input class='btn btn-block btn-primary' type="submit" value="Solicitar" id="solicitar"/>
        </form>

    </div>
    <img class="col-md-6">
        <img src="{{muestra.imagen.url}}" width="400px" >
        <p>{{muestra.descripcion}}</p>

     {%if mensaje != "ok"%}
        <div class="alert alert-danger col-md-6">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                {{mensaje}}
        </div>
     {%endif%}
    </div>
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>

    <script src="https://cdn.jsdelivr.net/jquery.validation/1.15.0/jquery.validate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/jquery.validation/1.15.0/additional-methods.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
            $('#project').change(function(){
                project_id = $(this).val();
                request_url = '/solicitarMuestra/experimentos/?project_id=' + project_id ;
                $('#experiment')
                .find('option')
                .remove()
                .end()
                .append('<option value="">--Seleccione--</option>')
                .val('');

                $('#protocol')
                .find('option')
                .remove()
                .end()
                .append('<option value="">--Seleccione--</option>')
                .val('');

                $('#step')
                .find('option')
                .remove()
                .end()
                .append('<option value="">--Seleccione--</option>')
                .val('');

                if (this.value == -1 || this.value=="") {

                    return false;
                }
                $.ajax({
                    type: "POST",
                    url: request_url,
                    data: JSON.stringify({
                        id_country: project_id
                    }),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    success: function (data) {
                        if (data != null) {
                            $.each(data, function (key, value) {
                                $('#experiment').append($("<option/>").val(key).text(value));
                            });
                        } else {
                            console.log('error')
                        }

                    },
                    failure: function (errMsg) {
                        alert('Hubo un error');
                    }
                });
            });
            $('#experiment').change(function(){
                experiment_id = $(this).val();
                request_url = '/solicitarMuestra/protocolos/?experiment_id=' + experiment_id ;
                $('#protocol')
                .find('option')
                .remove()
                .end()
                .append('<option value="">--Seleccione--</option>')
                .val('');

                $('#step')
                .find('option')
                .remove()
                .end()
                .append('<option value="">--Seleccione--</option>')
                .val('');

                if (this.value == -1 || this.value=="") {
                    return false;
                }
                $.ajax({
                    type: "POST",
                    url: request_url,
                    data: JSON.stringify({
                        id_country: experiment_id
                    }),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    success: function (data) {
                        if (data != null) {
                            $.each(data, function (key, value) {
                                $('#protocol').append($("<option/>").val(key).text(value));
                            });
                        } else {
                            console.log('error')
                        }

                    },
                    failure: function (errMsg) {
                        alert('Hubo un error');
                    }
                });
            });
            $('#protocol').change(function(){
                protocol_id = $(this).val();
                request_url = '/solicitarMuestra/pasos/?protocol_id=' + protocol_id ;
                $('#step')
                .find('option')
                .remove()
                .end()
                .append('<option value="">--Seleccione--</option>')
                .val('');

                if (this.value == -1 || this.value=="") {
                    return false;
                }
                $.ajax({
                    type: "POST",
                    url: request_url,
                    data: JSON.stringify({
                        id_country: protocol_id
                    }),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    success: function (data) {
                        if (data != null) {
                            $.each(data, function (key, value) {
                                $('#step').append($("<option/>").val(key).text(value));
                            });
                        } else {
                            console.log('error')
                        }

                    },
                    failure: function (errMsg) {
                        alert('Hubo un error');
                    }
                });
            });


            jQuery.validator.setDefaults({
              debug: true,
              success: "valid"
            });
            $("#formSolicitud").submit(function(e) {
                e.preventDefault();
            }).validate({
                rules: {
                cantidad: {
                  required: true,
                  digits: true,
                  min:1,
                  max: $("#cantidadActual").html()
                },
                experiment: {
                  required: true
                },
                protocol: {
                  required: true
                },
                step: {
                  required: true
                }
                },
                submitHandler: function(form) {
                    $("#formSolicitud").submit();
                    //submit via ajax
                    return false;  //This doesn't prevent the form from submitting.
                }
            });
            $( ".datepicker" ).datepicker({
              changeMonth: true,
              changeYear: true,
              yearRange: "1900:2012",
              // You can put more options here.

            });

    </script>
</div>
{% endblock %}